[TOC]

摘自《深入理解Java虚拟机》第二版

# Java内存模型

Java虚拟机规范中定义了一种Java内存模型（Java Memory Model, JMM）来屏蔽掉各种硬件和操作系统的内存访问差异，以实现让Java程序在各种平台下都能达到一致性内存访问的效果。

## 1 主内存和工作内存

JMM规定：

- 所有的变量都存放在**主内存**中（类似物理硬件的主内存）

- 每条线程有自己的**工作内存**（类似高速缓存）
- 线程的工作内存保存了该线程使用到的变量的主内存**副本拷贝**
- 线程对变量的所有操作都（读取、赋值等）都必须在工作内存中进行，不能在主内存中直接操作。
- 不同线程之间也无法直接访问对方工作内存中的变量。
- 线程间变量值得传递需要通过主内存完成。

线程、主内存、工作内存关系：

![](..\..\picture\线程&主内存&工作内存关系.png)

## 2 内存间的交互

- lock (锁定）：作用丁于主内存的变量,它把一个变量标识为一条线程独占的状态。
- unlock (解锁）：作用于主内存的变量，它把一个处于锁定状态的变量释放出来，释放后的变量才可以被其他线程锁定。
- read (读取）：作用于主内存的变量,它把一个变量的值从主内存传输到线程的工作内存中，以便随后的load动 作使用。
- load (载人）：作用于工作内存的变量,它把read操作从主内存中得到的变量值放入工作内存的变最副本中。
- use (使用）：作用于工作内存的变量，它把工作内存中一个变量的值传递给执行引擎，毎当虛拟机遇到一个需要使用到变量的值的字节码指令时将会执行这个操作。
- assign (赋值）：作用于工作内存的变量,它把一个从执行引擎接收到的值赋给工作内存的变量，每当虚拟机遇到一个给变量赋值的字节码指令时执行这个操作。
- store (存储）：作用于工作内存的变量,它把工作内存中一个变量的值传送到主内存中，以便随后的write操作使用。
- write(写入)：作用于主内存的变量，它把store操作从工作内存中得到的变量值放入到主内存的变量中。
