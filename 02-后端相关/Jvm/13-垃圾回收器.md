[toc]

# 垃圾回收器

## 1 垃圾回收器概述

GC垃圾收集器是和JVM一脉相承的，它是和JVM进行搭配使用，在不同的使用场景对应的收集器也是有区别。

为什么要有很多收集器，一个不够吗？因为Java的使用场景很多，移动端，服务器等。所以就需要针对不同的场景，提供不同的垃圾收集器，提高垃圾收集的性能。

虽然我们会对各个收集器进行比较，但并非为了挑选一个最好的收集器出来。没有一种放之四海皆准、任何场景下都适用的完美收集器存在，更加没有万能的收集器。所以我们选择的只是对具体应用最合适的收集器。

## 2 垃圾回收器分类

### 2.1 按线程数分

**按线程数分**（垃圾回收线程数）可以分为串行垃圾回收器和并行垃圾回收器。 

<img src="picture/1609683010292.png" alt="1609683010292" style="zoom:50%;" />

串行回收指的是在同一时间段内只允许有一个CPU用于执行垃圾回收操作，此时工作线程被暂停，直至垃圾收集工作结束。

- 在诸如**单CPU处理器**或者较小的应用内存等硬件平台不是特别优越的场合，串行回收器的性能表现可以超过并行回收器和并发回收器。所以，串行回收默认被应用在客户端的Client模式下的JVM中
- 在并发能力比较强的CPU上，并行回收器产生的停顿时间要短于串行回收器。

和串行回收相反，并行收集可以运用多个CPU同时执行垃圾回收，因此提升了应用的吞吐量，不过并行回收仍然与串行回收一样，采用独占式，使用了“stop-the-world”机制。

### 2.2 按工作模式分

按照工作模式分可以分为并发式垃圾回收器和独占式垃圾回收器。

- 并发式垃圾回收器与应用程序线程交替工作，以尽可能减少应用程序的停顿时间。
- 独占式垃圾回收器（Stop the world）一旦运行，就停止应用程序中的所有用户线程，直到垃圾回收过程完全结束。

<img src="picture/1609683120991.png" alt="1609683120991" style="zoom:67%;" />

### 2.3 按碎片处理方式分

按碎片处理方式分可分为压缩武垃圾回收器和非压缩式垃圾回收器。

- 压缩式垃圾回收器会在回收完成后，对存活对象进行压缩整理，消除回收后的碎片。
- 非压缩式的垃圾回收器不进行这步操作。

按工作的内存区间分，又可分为年轻代垃圾回收器和老年代垃圾回收器。

## 3 垃圾回收器的衡量指标

为了衡量垃圾回收器的好坏，即垃圾回收器的快慢、效率的高低等，衡量指标主要有下面几个：

- **吞吐量**：运行用户代码的时间占总运行时间的比例（总运行时间 = 程序的运行时间 + 内存回收的时间）
    - 吞吐量=运行用户代码时间 /（运行用户代码时间+垃圾收集时间） ，比如虚拟机总共运行了100分钟，其中垃圾收集花掉1分钟，那吞吐量就是99%。 
- **垃圾收集开销**：吞吐量的补数，垃圾收集所用时间与总运行时间的比例。
- **暂停时间**：执行垃圾收集时，程序的工作线程被暂停的时间。
- **收集频率**：相对于应用程序的执行，收集操作发生的频率。
- **内存占用**：Java堆区所占的内存大小。
- **快速**：一个对象从诞生到被回收所经历的时间。

吞吐量、暂停时间、内存占用 这三者共同构成一个“不可能三角”。

三者总体的表现会随着技术进步而越来越好，一款优秀的收集器通常最多同时满足其中的两项。 
这三项里，暂停时间的重要性日益凸显。因为随着硬件发展，内存占用多些越来越能容忍，硬件性能的提升也有助于降低收集器运行时对应用程序的影响，即提高了吞吐量。而内存的扩大，对延迟反而带来负面效果。 

## 3 常见的垃圾回收器以及分类

### 3.1 垃圾回收器按串并行分

- 串行回收器：Serial、Serial old
- 并行回收器：ParNew、Parallel Scavenge、Parallel old
- 并发回收器：CMS、G1

### 3.2 垃圾回收器与垃圾分代的关系

![1609684285394](picture/1609684285394.png)

新生代收集器：Serial、ParNew、Parallel Scavenge；

老年代收集器：Serial old、Parallel old、CMS；

整堆收集器：G1

### 3.3 垃圾回收器的组合关系

<img src="picture/1609684350943.png" alt="1609684350943" style="zoom:55%;" />

- 两个收集器间有连线，表明它们可以搭配使用：Serial/Serial old、Serial/CMS、ParNew/Serial old、ParNew/CMS、Parallel Scavenge/Serial Old、Parallel Scavenge/Parallel old、G1；
- 其中Serial old作为CMS出现"Concurrent Mode Failure"失败的后备预案。
- （红色虚线）由于维护和兼容性测试的成本，在JDK 8时将Serial+CMS、ParNew+Serial old这两个组合声明为废弃（JEP173），并在JDK9中完全取消了这些组合的支持（JEP214）即：移除。
- （绿色虚线）JDK14中：弃用Paralle1 Scavenge和Serialold GC组合（JEP366）
- （青色虚线）JDK14中：删除CMS垃圾回收器（JEP363）

## 4 不同的垃圾回收器

### 4.1 Serial回收器-串行回收



### 4.2 ParNew回收器-并行回收



### 4.3 Parallel回收器-吞吐量优先



### 4.4 CMS回收器-低延迟



### 4.5 G1回收器-区域化分代式





## 5 总结





## ps-相关资料