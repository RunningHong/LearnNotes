[TOC]

# 数仓分层

## 1 分层结构

- 数据引入层ODS（Operation Data Store）：存放未经过处理的原始数据至数据仓库系统，结构上与源系统保持一致，是数据仓库的数据准备区。

- 数据公共层CDM（Common Data Model，又称通用数据模型层），包括DIM维度表、DWD和DWS，由ODS层数据加工而成。主要完成数据加工与整合，建立一致性的维度，构建可复用的面向分析和统计的明细事实表，以及汇总公共粒度的指标。

  - 公共维度层（DIM）：基于维度建模理念思想，建立整个企业的一致性维度。降低数据计算口径和算法不统一风险。

    公共维度层的表通常也被称为逻辑维度表，维度和维度逻辑表通常一一对应。

  - 公共汇总粒度事实层（DWS）：以分析的主题对象作为建模驱动，基于上层的应用和产品的指标需求，构建公共粒度的汇总指标事实表，以宽表化手段物理化模型。构建命名规范、口径一致的统计指标，为上层提供公共指标，建立汇总宽表、明细事实表。

    公共汇总粒度事实层的表通常也被称为汇总逻辑表，用于存放派生指标数据。

  - 明细粒度事实层（DWD）：以业务过程作为建模驱动，基于每个具体的业务过程特点，构建最细粒度的明细层事实表。可以结合企业的数据使用特点，将明细事实表的某些重要维度属性字段做适当冗余，即宽表化处理。

    明细粒度事实层的表通常也被称为逻辑事实表。

- 数据应用层ADS（Application Data Service）：存放数据产品个性化的统计指标数据。根据CDM与ODS层加工生成。

## 2 层级描述

| 层级  | 注意事项                                                     | 示例                                                         | 备注 |
| :---: | :----------------------------------------------------------- | :----------------------------------------------------------- | :--: |
| ODS层 | 1.目前接入数据源类型主要包括：MySQL、日志、外表。初始数据都放在这一层。<br />2.本层数据不做任何处理，与源数据保持一致。<br />3.同步尽量保留日采分区（本层修复表）。 | 订单表采集binlog采集日志、微信push后端服务采集日志、外事业部同步外表等 |      |
| DWS层 | 1.基于DWS层的表做数据汇总，从业务角度建设<br />2.表建设尽量考虑复用性 | 基于用户统计订单数、基于用户/BU统计订单数                    |      |
| DWD层 | 1.从ODS解析的数据明细表（编码转换、清洗、统一格式、脱敏等）。<br />2.本层表类型分为三种：拉链表、分区表、快照表。<br />3.本层只做某一个ODS数据的处理，不做其他数据的扩充。<br />4.数据校验 | 订单采集之后合并成快照表、日增积分对账表为分区表             |      |
| ADS层 | 上层应用使用                                                 |                                                              |      |

## 3 分层命名规范

### 3.1 DIM层

```
说明：维度表（一般为外表） 
命名：分层_数据域_子主题域_描述_更新周期
```

### 3.2 ODS层 

```
说明：原始数据，不做任何修改（一般为外表） 注意：调度任务尽可能早 
命名：ods_来源类型_描述_增量/全量标识
来源类型：
ext:外表（external）
db:db来源(如mysql)
log:从日志中采集

数据周期：
增量数据：di
全量数据：dd
按小时的增量表：hi
按小时的全量表：hh

例如：
ods_log_behavior_hi(按小时增量的从日志收集的行为信息)
ods_db_order_di(按天增量的从数据库收集的订单数据)
```

更新周期

| 分表策略 | 说明                                                         |
| :------- | :----------------------------------------------------------- |
| dd       | 每天分区中保留的是历史至今的全量数据，根据业务使用场景制定例行清理策略 |
| di       | 每天分区中保留的是当日的增量数据，可以是汇总数据也可以是明细数据，一般永久保留 |
| md       | 每月的分区中保留的是历史至今的全量数据，根据业务使用场景制定例行清理策略 |
| mi       | 每月的分区中保留的是对应月份的整个月的增量数据，可以是汇总数据也可以是明细数据，一般永久保存 |
| nd       | 死表或者不定期更新的全量表                                   |
| wd       | 每周的分区中保留的是历史至今的全量数据，根据业务使用场景制定例行清理策略 |
| wi       | 每周的分区中保留的是对应周的增量数据，可以是汇总数据也可以是明细数据，一般永久保留 |

### 3.3 DWD层

```
说明：对原始数据拆解，不做横向扩展（一般为内表） 
命名：dwd_数据域_子主题域_描述_表类型_增量/全量标识
表类型：
his:拉链表（history）
part:分区表(partition)
snap:快照表(snapshot)

例如： dwd_order_hotel_part_di（酒店订单下单事实表，日刷新增量）
```

### 3.4 DWS层

```
说明：按照主题组合事实表与维度表（一般为内表）
命名：dws_数据域_子主题域_统计粒度(缩写)_描述_统计周期范围(缩写)
```

- 在默认情况下，离线计算应该包括最近一天（1d）、最近N天（nd）和历史截至当天（td）三个表。

  如果nd表的字段过多，需要拆分时，只允许以一个统计周期单元作为原子拆分，即一个统计周期拆分一个表。例如，最近7天（1w）拆分一个表，不允许拆分出来的一个表存储多个统计周期。

- 对于{刷新周期标识}和{单分区增量全量标识}在汇总层不做强制要求。单分区增量全量标识：i表示增量，f表示全量。

- 对于小时表不管是按天刷新还是按小时刷新，都用_hh来表示。

- 对于分钟表不管是按天刷新还是按小时刷新，都用_mm来表示。





