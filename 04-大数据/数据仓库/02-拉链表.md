[TOC]

# 拉链表

## 1 拉链表使用场景

在数据仓库的数据模型设计过程中，经常会遇到下面这种表的设计：

1. 有一些表的数据量很大，比如一张用户表，大约 10 亿条记录，50 个字段，这种表，即使使用 Orc 压缩，单张表的存储也会超过 100G，在 Hdfs 使用双备份或者三备份的话就更大一些。
2. 表中的部分字段会被 Update 更新操作，如用户联系方式，产品的描述信息，订单的状态等等。
3. 需要查看某一个时间点或者时间段的历史快照信息，比如，查看某一个订单在历史某一个时间点的状态。
4. 表中的记录变化的比例和频率不是很大，比如，总共有 10 亿的用户，**每天新增和发生变化的有 200 万左右，变化的比例占的很小**。

那么对于这种表有下面有几种方案可选：

- 方案一：每天只留最新的一份，比如我们每天用 Sqoop 抽取最新的一份全量数据到 Hive 中。
- 方案二：每天保留一份全量的切片数据。
- 方案三：使用拉链表。

方案一：最终我们拿到的只是最后的状态，数据具体的变更流程我们全拿不到（如需要分析某一天的数据改场景就不适用了）

方案二：可以拿到最新的数据，并且历史数据也在，可以通过这些数据查看历史的变化，**但是每一天的全量数据，占得空间太大了**。

方案三：使用拉链表，变化的数据（周期性）都会被存入表中，相对于方案一：拉链表可以存取历史数据状态，相对于方案2，拉链表每天新增的数据的相当于前一天变更的数据，所以也很节省空间。

## 2 拉链表的设计与实现

### 2.1  现实场景

就拿我们注册的用户信息来说，按天来看，每天都有新增的用户信息，还有一些是在原有基础上更新的数据信息。

一般我们的用户最新的用户信息都会存在于mysql中,并且存放的是新的信息，如下表：

| user_id | user_name | phone | create_time | update_time |
| ------- | --------- | ----- | ----------- | ----------- |
| 1       | A         | 1111  | 2020-01-01  | 2020-01-01  |
| 2       | B         | 2222x | 2020-01-01  | 2020-01-02  |
| 3       | C         | 3333x | 2020-01-01  | 2020-01-02  |



### 2.2 拉链表设计

首先先看一下拉链表的特点：

1. 首先需要一堆基础数据，代表当前最新的状态，后续的更新都是在这基础上更改的
2. 数据新增：每天更新的数据如果是新增的就直接加进去
3. 数据更新：每天更新的数据如果是更新状态就把原来的数据的状态置于失效，把这次更新的数据置于最新

### 2.3 拉链表实现



