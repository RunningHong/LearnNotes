[toc]

# LSM树

## 1 原理

LSM树即Log-Structured Merge Tree（日志结构合并树）

原理：首先把一棵大树拆分成N棵小树，它首先写入内存中，随着小树越来越大，内存中的小树会flush到磁盘中，磁盘中的树定期可以做merge操作，合并成一棵大树，以优化读性能。

传统关系型数据库使用btree或一些变体作为存储结构，能高效进行查找。但保存在磁盘中时它也有一个明显的缺陷，那就是逻辑上相离很近但物理却可能相隔很远，这就可能造成大量的磁盘随机读写。随机读写比顺序读写慢很多，为了提升IO性能，我们需要一种能将随机操作变为顺序操作的机制，于是便有了LSM树。LSM树能让我们进行顺序写磁盘，从而大幅提升写操作。

LSM存储引擎和B树存储引擎一样，同样支持增、删、读、改、顺序扫描操作。而且通过批量存储技术规避磁盘随机写入问题。LSM树与B树相比，牺牲了部分的读性能，大幅提高写性能。LSM Tree，对于最简单的二层LSM Tree而言，即把内存中的数据和磁盘中的数据进行merge操作。

## 2 HBase中的LSM树-HBase的读写流程体现了这点

数据会先写到内存中，为了防止内存数据丢失，写内存的同时需要持久化到磁盘，对应了HBase的MemStore和HLog；
MemStore中的数据达到一定的阈值之后，需要将数据刷写到磁盘，即生成HFile（也是一颗小的B+树）文件；
HBase中的minorCompact操作（少量HFile小文件合并）和majorCompact操作（一个region的所有HFile文件合并，同时删除无效数据[过期及删除的数据]），多棵小树在这个时机合并成大树，来增强读性能。

## ps-相关资料

[HBASE-LSM树](https://www.jianshu.com/p/06f9f7f41fdb)

[Hbase中的LSM树](https://zhuanlan.zhihu.com/p/135371171)