[TOC]

# TCP三次握手四次挥手

## 1 基础知识

- **SYN（SYNchronization）**：同步序号，用来建立连接。
  SYN标志位和ACK标志位搭配使用，当SYN=1，ACK=0，表示连接请求；当SYN=1，ACK=1，表示连接被响应的时候；这个标志的数据包经常被用来进行端口扫描。
- **ACK（ACKnowledgment）**：确认号，用于确认连接是否有效。
  仅当ACK=1时确认号字段有效，当ACK=0时是无效的。TCP规定在连接建立后所有传送的报文段都必须把ACK置为1。
- **ACKNum(Acknowledgment Number)**：所期望收到的下一个序列号。
  32位确认序列号包含发送确认的一端所期望收到的下一个序号，因此，确认序号应当是上次已成功收到数据字节序号加1。不过，只有当标志位中的ACK标志（下面介绍）为1时该确认序列号的字段才有效。主要用来解决不丢包的问题；
- **seq（Sequence Number）**：序列号。
- **FIN（finish）**：表示终结连接。
  当 FIN = 1 时，表明此报文段的发送方的数据已经发送完毕，并要求释放连接。

## 2 三次握手

- **第一次握手**（SYN=1，ACK=0，seq=x）
  客户端发送一个TCP的数据包（SYN=1，ACK=0）指明客户端打算连接服务器的端口，以及初始序号 X,保存在包头的序列号(Sequence Number)字段里。
- **第二次握手**（SYN=1, ACK=1, seq=y, ACKnum=x+1）
  服务器发回确认包(ACK)应答。即 SYN 标志位和 ACK 标志位均为1。服务器端选择自己 seq序列号，放到 Seq 域里，同时将确认序号(ACKNum)设置为客户的 seq加1，即X+1。 发送完毕后，服务器端进入 `SYN_RCVD` 状态。
- **第三次握手**（ACK=1，ACKnum=y+1）
  客户端再次发送确认包(ACK)，SYN 标志位为0，ACK 标志位为1，并且把服务器发来 ACK 的序号字段+1，放在确定字段中发送给对方，并且在数据段放写seq的+1发送完毕后，客户端进入 `ESTABLISHED` 状态，当服务器端接收到这个包时，也进入 `ESTABLISHED` 状态，TCP 握手结束。

**三次握手模拟现实场景**：

客户端：“你好，在家不，有你的快递？”

服务端：“在的，送上来吧”

客户端：“好，这就给你送上来”

## 3 四次挥手

为了避免服务器与客户端双方的资源占用和损耗，当双方没有请求或响应传递时，任意一方都可以发起关闭请求。与创建TCP连接的3次握手类似，关闭TCP连接，需要**4次握手**。

![å¾çæè¿°](https://segmentfault.com/img/bVYQci?w=489&h=374)

**模拟现实场景**

客户端：“兄弟，我这边没数据要传了，咱关闭连接吧。”

服务端：“收到，我看看我这边有木有数据了。”

服务端：“兄弟，我这边也没数据要传你了，咱可以关闭连接了。”

客户端：“好嘞。” 